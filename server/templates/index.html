<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOCX Template Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            background: #f8f9fa;
        }

        .tab-button {
            flex: 1;
            padding: 18px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            background: white;
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2::before {
            content: '';
            width: 4px;
            height: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 6px;
            font-size: 0.95em;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="file"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .button-secondary {
            background: #6c757d;
        }

        .button-danger {
            background: #dc3545;
        }

        .button-small {
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.15);
        }

        .card h3,
        .card h4 {
            color: #333;
            margin-bottom: 12px;
        }

        .card p {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.95em;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .checkbox-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        .variable-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .variable-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .variable-input {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .variable-input input {
            flex: 1;
        }

        .variable-input button {
            padding: 10px 16px;
            white-space: nowrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .tab-button {
                padding: 12px;
                font-size: 0.9em;
            }

            .tab-content {
                padding: 20px;
            }
        }
    </style>
    <!-- PDF.js –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º worker –¥–ª—è PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ DOCX Template Manager</h1>
            <p>–£–ø—Ä–∞–≤–ª—è–π —à–∞–±–ª–æ–Ω–∞–º–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å –ª–µ–≥–∫–æ—Å—Ç—å—é</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('collections')">–ö–æ–ª–ª–µ–∫—Ü–∏–∏</button>
            <button class="tab-button" onclick="switchTab('templates')">–®–∞–±–ª–æ–Ω—ã</button>
            <button class="tab-button" onclick="switchTab('render')">–†–µ–Ω–¥–µ—Ä–∏–Ω–≥</button>
            <button class="tab-button" onclick="switchTab('batch-render')">Batch –†–µ–Ω–¥–µ—Ä–∏–Ω–≥</button>
        </div>

        <!-- –ö–û–õ–õ–ï–ö–¶–ò–ò -->
        <div id="collections" class="tab-content active">
            <div class="section">
                <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é</h2>
                <div class="form-row">
                    <input type="text" id="collectionName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏">
                    <textarea id="collectionDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" style="resize: vertical;"></textarea>
                </div>
                <button onclick="createCollection()">‚úö –°–æ–∑–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é</button>
            </div>

            <div class="section">
                <h2>–ú–æ–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h2>
                <div id="collectionsList" class="grid"></div>
            </div>

            <div id="collectionEditPanel" style="display: none;">
                <div class="section">
                    <h2>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h2>
                    <button onclick="closeCollectionEdit()" class="button-secondary button-small">‚Üê –ù–∞–∑–∞–¥</button>

                    <div id="collectionVarsList" style="margin-top: 20px;" class="grid"></div>

                    <div class="variable-section">
                        <h3>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é</h3>
                        <div class="form-group">
                            <label>–ò–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π</label>
                            <input type="text" id="newVarName" placeholder="my_variable">
                        </div>
                        <div class="form-row">
                            <div>
                                <label>–¢–∏–ø</label>
                                <select id="newVarType">
                                    <option value="text">text</option>
                                    <option value="checkbox">checkbox</option>
                                </select>
                            </div>
                            <div>
                                <label>–ó–Ω–∞—á–µ–Ω–∏–µ</label>
                                <input type="text" id="newVarValue" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (JSON)</label>
                            <input type="text" id="newVarMetadata" placeholder='{"display_name":"..."}'>
                        </div>
                        <button onclick="saveCollectionVariable()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –®–ê–ë–õ–û–ù–´ -->
        <div id="templates" class="tab-content">
            <div class="section">
                <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω</h2>
                <div class="form-row">
                    <select id="templateCollection">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>
                    </select>
                    <input type="text" id="templateName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞">
                </div>
                <div class="form-group">
                    <label>–§–∞–π–ª DOCX</label>
                    <input type="file" id="templateFile" accept=".docx">
                </div>
                <button onclick="uploadTemplate()">‚¨Ü –ó–∞–≥—Ä—É–∑–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
            </div>

            <div class="section">
                <h2>–®–∞–±–ª–æ–Ω—ã –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h2>
                <select id="viewCollection" onchange="loadTemplates()" style="margin-bottom: 20px;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>
                </select>
                <div id="templatesList" class="grid"></div>
            </div>
        </div>

        <!-- –†–ï–ù–î–ï–†–ò–ù–ì -->
        <div id="render" class="tab-content">
            <div class="section">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞</h2>
                <div class="form-row">
                    <select id="renderCollection" onchange="loadCollectionsForRender()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>
                    </select>
                    <select id="renderTemplate" onchange="loadRenderVariables()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</option>
                    </select>
                </div>
            </div>

            <div id="renderVariablesSection"></div>

            <div class="section" style="display: flex; gap: 10px;">
                <button onclick="showPdfPreview()"
                    style="flex: 1; padding: 14px; font-size: 1.1em; background: #667eea;">üëÅ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä PDF</button>
                <button onclick="performRender()" style="flex: 1; padding: 14px; font-size: 1.1em;">‚¨á –°–∫–∞—á–∞—Ç—å
                    –¥–æ–∫—É–º–µ–Ω—Ç</button>
            </div>
        </div>

        <!-- PDF –ü–†–ï–î–ü–†–û–°–ú–û–¢–† MODAL -->
        <div id="pdfModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
            <div
                style="position: relative; width: 90%; height: 90%; margin: 5% auto; background: white; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #eee;">
                    <h2 style="margin: 0;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä PDF</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="previousPage()"
                            style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">‚Üê
                            –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
                        <span id="pageInfo" style="min-width: 100px; text-align: center;">–°—Ç—Ä. 1</span>
                        <button onclick="nextPage()"
                            style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">–°–ª–µ–¥—É—é—â–∞—è
                            ‚Üí</button>
                        <button onclick="closePdfPreview()"
                            style="padding: 8px 15px; background: #999; color: white; border: none; border-radius: 6px; cursor: pointer;">‚úï
                            –ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
                <div id="pdfContainer"
                    style="flex: 1; overflow: auto; display: flex; justify-content: center; align-items: flex-start; background: #f0f0f0; padding: 20px;">
                    <canvas id="pdfCanvas" style="max-width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></canvas>
                </div>
            </div>
        </div>

        <!-- BATCH –†–ï–ù–î–ï–†–ò–ù–ì -->
        <div id="batch-render" class="tab-content">
            <div class="section">
                <h2>–ü–∞–∫–µ—Ç–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —à–∞–±–ª–æ–Ω–æ–≤</h2>
                <div class="form-row">
                    <select id="batchRenderCollection" onchange="loadBatchTemplates()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω—ã</h2>
                <div id="batchTemplatesCheckboxes"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                </div>
            </div>

            <div id="batchVariablesSection"></div>

            <div class="section">
                <button onclick="performBatchRender()" style="width: 100%; padding: 14px; font-size: 1.1em;">‚¨á
                    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤</button>
            </div>
        </div>
    </div>

    <div id="statusContainer"></div>

    <script>
        function showStatus(message, type = 'success') {
            const div = document.createElement('div');
            div.className = `status status-${type}`;
            div.textContent = message;
            document.getElementById('statusContainer').appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'collections') loadCollections();
            else if (tabName === 'templates') { loadCollections(); loadTemplates(); }
            else if (tabName === 'render') { loadCollectionsForRender(); }
            else if (tabName === 'batch-render') { loadBatchCollections(); }
        }

        function safeId(name) {
            return name.replace(/[^a-zA-Z0-9\-_]/g, '_');
        }

        // ===== –ö–û–õ–õ–ï–ö–¶–ò–ò =====
        async function loadCollections() {
            try {
                const resp = await fetch('/api/collections');
                const collections = await resp.json();

                document.getElementById('templateCollection').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>';
                document.getElementById('viewCollection').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>';

                collections.forEach(c => {
                    document.getElementById('templateCollection').innerHTML += `<option value="${c.id}">${c.name}</option>`;
                    document.getElementById('viewCollection').innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });

                const list = document.getElementById('collectionsList');
                if (collections.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π. –°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é!</p></div>';
                    return;
                }

                list.innerHTML = collections.map(c => `
                    <div class="card">
                        <h3>${c.name}</h3>
                        <p>${c.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        <p style="color: #999; font-size: 0.85em;">–®–∞–±–ª–æ–Ω–æ–≤: <strong>${c.templates?.length || 0}</strong></p>
                        <div class="card-actions">
                            <button class="button-small" onclick="editCollectionVariables('${c.id}')">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π', 'error');
            }
        }

        async function createCollection() {
            const name = document.getElementById('collectionName').value.trim();
            const desc = document.getElementById('collectionDesc').value.trim();

            if (!name) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏', 'error');
                return;
            }

            try {
                const fd = new FormData();
                fd.append('name', name);
                fd.append('description', desc);

                const resp = await fetch('/api/collections', { method: 'POST', body: fd });
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');

                showStatus('–ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ ‚úì');
                document.getElementById('collectionName').value = '';
                document.getElementById('collectionDesc').value = '';
                loadCollections();
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function editCollectionVariables(collectionId) {
            window.currentCollectionId = collectionId;
            document.getElementById('collectionsList').parentElement.style.display = 'none';
            document.getElementById('collectionEditPanel').style.display = 'block';
            await loadCollectionVariablesForEdit(collectionId);
        }

        function closeCollectionEdit() {
            document.getElementById('collectionEditPanel').style.display = 'none';
            document.getElementById('collectionsList').parentElement.style.display = 'block';
            document.getElementById('collectionsList').innerHTML = '';
            loadCollections();
        }

        async function loadCollectionVariablesForEdit(collectionId) {
            try {
                const resp = await fetch(`/api/collections/${collectionId}/variables`);
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

                const vars = await resp.json();
                const list = document.getElementById('collectionVarsList');

                if (Object.keys(vars).length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</p></div>';
                    return;
                }

                list.innerHTML = Object.entries(vars).map(([name, v]) => `
                    <div class="card">
                        <h4>${v.metadata?.display_name || name}</h4>
                        <p style="color: #666; font-size: 0.9em;">${v.metadata?.description || ''}</p>
                        <p><strong>–¢–∏–ø:</strong> ${v.type}</p>
                        <p style="color: #667eea; font-size: 0.9em;">
                            <strong>–í—Ö–æ–∂–¥–µ–Ω–∏–π:</strong> ${v.occurrences_total || 0} 
                            ${v.templates_count ? `–≤ ${v.templates_count} —à–∞–±–ª–æ–Ω${v.templates_count === 1 ? '–µ' : '–∞—Ö'}` : '(–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)'}
                        </p>
                        ${v.authors && v.authors.length > 0 ? `
                            <div style="background: #f0f4ff; border-radius: 6px; padding: 10px; margin-top: 10px;">
                                <p style="font-size: 0.85em; color: #555; margin-bottom: 5px;"><strong>üë§ –ê–≤—Ç–æ—Ä—ã:</strong></p>
                                ${v.authors.map(auth => `
                                    <p style="font-size: 0.8em; color: #666; margin: 3px 0;">
                                        <strong>${auth.author || 'Unknown'}</strong>
                                        ${auth.date ? `<span style="color: #999;">${new Date(auth.date).toLocaleDateString('ru-RU')}</span>` : ''}
                                    </p>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <label style="margin-bottom: 10px; font-size: 0.95em;">–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
                            <input type="text" id="var_edit_value_${safeId(name)}" value="${v.value || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="margin-bottom: 10px; font-size: 0.95em;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                            <textarea id="var_edit_desc_${safeId(name)}" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 6px; font-size: 0.95em; font-family: inherit; min-height: 60px; resize: vertical;">${v.metadata?.description || ''}</textarea>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="margin-bottom: 10px; font-size: 0.95em;">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                            <input type="text" id="var_edit_display_${safeId(name)}" value="${v.metadata?.display_name || ''}" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 6px; font-size: 0.95em;">
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 15px;">
                            <button onclick="updateCollectionVar('${name}', '${v.type}', document.getElementById('var_edit_value_${safeId(name)}').value, document.getElementById('var_edit_desc_${safeId(name)}').value, document.getElementById('var_edit_display_${safeId(name)}').value)" style="flex: 1; padding: 10px 16px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button class="button-danger" onclick="deleteCollectionVar('${name}')" style="padding: 10px 16px;">üóë –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö', 'error');
            }
        }

        async function saveCollectionVariable() {
            const collectionId = window.currentCollectionId;
            const name = document.getElementById('newVarName').value.trim();
            const type = document.getElementById('newVarType').value;
            const value = document.getElementById('newVarValue').value;
            const metaStr = document.getElementById('newVarMetadata').value;

            if (!name) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π', 'error');
                return;
            }

            try {
                let meta = null;
                if (metaStr) meta = JSON.parse(metaStr);

                const fd = new FormData();
                fd.append('name', name);
                fd.append('type', type);
                fd.append('value', value);
                if (meta) fd.append('metadata', JSON.stringify(meta));

                const resp = await fetch(`/api/collections/${collectionId}/variables`, { method: 'POST', body: fd });
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');

                showStatus('–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úì');
                document.getElementById('newVarName').value = '';
                document.getElementById('newVarValue').value = '';
                document.getElementById('newVarMetadata').value = '';
                await loadCollectionVariablesForEdit(collectionId);
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function updateCollectionVar(name, varType, value, description, displayName) {
            const collectionId = window.currentCollectionId;
            try {
                const metadata = {
                    description: description || '',
                    display_name: displayName || name
                };

                const fd = new FormData();
                fd.append('name', name);
                fd.append('type', varType || 'text');
                fd.append('value', value);
                fd.append('metadata', JSON.stringify(metadata));

                const resp = await fetch(`/api/collections/${collectionId}/variables`, { method: 'POST', body: fd });
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞');

                showStatus('–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚úì');
                await loadCollectionVariablesForEdit(collectionId);
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function deleteCollectionVar(name) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é?')) return;

            const collectionId = window.currentCollectionId;
            try {
                const resp = await fetch(`/api/collections/${collectionId}/variables/${encodeURIComponent(name)}`, { method: 'DELETE' });
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞');

                showStatus('–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É–¥–∞–ª–µ–Ω–∞ ‚úì');
                await loadCollectionVariablesForEdit(collectionId);
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        // ===== –®–ê–ë–õ–û–ù–´ =====
        async function uploadTemplate() {
            const collectionId = document.getElementById('templateCollection').value;
            const name = document.getElementById('templateName').value.trim();
            const file = document.getElementById('templateFile').files[0];

            if (!collectionId || !name || !file) {
                showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const fd = new FormData();
                fd.append('collection_id', collectionId);
                fd.append('name', name);
                fd.append('file', file);

                const resp = await fetch('/api/collections/templates', { method: 'POST', body: fd });
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

                showStatus('–®–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω ‚úì');
                document.getElementById('templateName').value = '';
                document.getElementById('templateFile').value = '';
                loadTemplates();
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function loadTemplates() {
            const collectionId = document.getElementById('viewCollection').value;
            if (!collectionId) {
                document.getElementById('templatesList').innerHTML = '';
                return;
            }

            try {
                const resp = await fetch(`/api/collections/${collectionId}/templates`);
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞');

                const templates = await resp.json();
                const list = document.getElementById('templatesList');

                if (templates.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤</p></div>';
                    return;
                }

                list.innerHTML = templates.map(t => `
                    <div class="card">
                        <h3>${t.name}</h3>
                        <p style="color: #666; font-size: 0.9em;">${t.original_filename}</p>
                        <p>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: <strong>${Object.keys(t.variables || {}).length}</strong></p>
                        <p style="color: #999; font-size: 0.85em;">–°–æ–∑–¥–∞–Ω: ${new Date(t.created_at).toLocaleDateString('ru-RU')}</p>
                        <div class="card-actions">
                            <button class="button-small" onclick="rescanTemplate('${t.id}')">–ü–µ—Ä–µ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤', 'error');
            }
        }

        async function rescanTemplate(templateId) {
            try {
                const resp = await fetch(`/api/templates/${templateId}/rescan`, { method: 'POST' });
                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞');

                showStatus('–®–∞–±–ª–æ–Ω –ø–µ—Ä–µ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω ‚úì');
                loadTemplates();
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        // ===== –†–ï–ù–î–ï–†–ò–ù–ì =====
        async function loadCollectionsForRender() {
            try {
                const resp = await fetch('/api/collections');
                const collections = await resp.json();

                const select = document.getElementById('renderCollection');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>';
                collections.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });

                document.getElementById('renderTemplate').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</option>';
                document.getElementById('renderVariablesSection').innerHTML = '';
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π', 'error');
            }
        }

        async function loadCollectionsForRender() {
            try {
                const resp = await fetch('/api/collections');
                const collections = await resp.json();

                const select = document.getElementById('renderCollection');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>';
                collections.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });

                if (collections.length === 0) {
                    document.getElementById('renderTemplate').innerHTML = '<option value="">–ù–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π</option>';
                }
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω—ã –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        document.getElementById('renderCollection').addEventListener('change', async function () {
            const collectionId = this.value;
            if (!collectionId) {
                document.getElementById('renderTemplate').innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>';
                return;
            }

            try {
                const resp = await fetch(`/api/collections/${collectionId}/templates`);
                const templates = await resp.json();

                const select = document.getElementById('renderTemplate');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</option>';
                templates.forEach(t => {
                    select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });

                document.getElementById('renderVariablesSection').innerHTML = '';
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤', 'error');
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞
        async function loadRenderVariables() {
            const templateId = document.getElementById('renderTemplate').value;
            if (!templateId) {
                document.getElementById('renderVariablesSection').innerHTML = '';
                return;
            }

            try {
                const resp = await fetch(`/api/templates/${templateId}`);
                const template = await resp.json();

                const section = document.getElementById('renderVariablesSection');
                const vars = template.variables || {};

                if (Object.keys(vars).length === 0) {
                    section.innerHTML = '<div class="section"><div class="empty-state"><p>–í —ç—Ç–æ–º —à–∞–±–ª–æ–Ω–µ –Ω–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö</p></div></div>';
                    return;
                }

                let html = '<div class="section"><h2>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞</h2><div class="variable-section">';

                Object.entries(vars).forEach(([name, v]) => {
                    const displayName = v.metadata?.display_name || name;
                    const description = v.metadata?.description || '';
                    const value = v.value || '';
                    const authors = v.authors && v.authors.length > 0 ? v.authors : [];

                    let authorsHtml = '';
                    if (authors.length > 0) {
                        authorsHtml = `<p style="font-size: 0.75em; color: #999;">üë§ ${authors.map(a => a.author || 'Unknown').join(', ')}</p>`;
                    }

                    if (v.type === 'checkbox') {
                        html += `
                            <div class="form-group">
                                <label>${displayName}</label>
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 8px;">${description}</p>
                                ${authorsHtml}
                                <div class="checkbox-group">
                                    <input type="checkbox" id="var_${safeId(name)}" data-var-name="${name}" ${value ? 'checked' : ''}>
                                    <label for="var_${safeId(name)}" style="margin: 0;">–û—Ç–º–µ—á–µ–Ω–æ</label>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="form-group">
                                <label>${displayName}</label>
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 8px;">${description}</p>
                                ${authorsHtml}
                                <input type="text" id="var_${safeId(name)}" data-var-name="${name}" value="${value}" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
                            </div>
                        `;
                    }
                });

                html += '</div></div>';
                section.innerHTML = html;
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö', 'error');
            }
        }

        async function performRender() {
            const templateId = document.getElementById('renderTemplate').value;
            if (!templateId) {
                showStatus('–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω', 'error');
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            const variables = {};
            document.querySelectorAll('[data-var-name]').forEach(input => {
                const name = input.dataset.varName;
                if (input.type === 'checkbox') {
                    variables[name] = input.checked;
                } else {
                    variables[name] = input.value;
                }
            });

            try {
                const resp = await fetch('/api/render/single/json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ template_id: templateId, variables })
                });

                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞');

                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rendered_${Date.now()}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('–î–æ–∫—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω ‚úì');
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        // ===== PDF –ü–†–ï–î–ü–†–û–°–ú–û–¢–† =====
        let currentPdfDoc = null;
        let currentPageNum = 1;

        async function showPdfPreview() {
            const templateId = document.getElementById('renderTemplate').value;
            if (!templateId) {
                showStatus('–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω', 'error');
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
            const variables = {};
            document.querySelectorAll('[data-var-name]').forEach(input => {
                const name = input.dataset.varName;
                if (input.type === 'checkbox') {
                    variables[name] = input.checked;
                } else {
                    variables[name] = input.value;
                }
            });

            try {
                showStatus('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è PDF...', 'success');

                const resp = await fetch('/api/render/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ template_id: templateId, variables })
                });

                if (!resp.ok) throw new Error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF');

                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º PDF —Å –ø–æ–º–æ—â—å—é PDF.js
                pdfjsLib.getDocument(url).promise.then(pdf => {
                    currentPdfDoc = pdf;
                    currentPageNum = 1;
                    renderPdfPage(1);
                    document.getElementById('pdfModal').style.display = 'flex';
                    showStatus('PDF –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É ‚úì');
                }).catch(err => {
                    showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ PDF: ' + err.message, 'error');
                });
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function renderPdfPage(pageNum) {
            if (!currentPdfDoc) return;

            const page = await currentPdfDoc.getPage(pageNum);
            const canvas = document.getElementById('pdfCanvas');
            const context = canvas.getContext('2d');
            const scale = 1.5;
            const viewport = page.getViewport({ scale });

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };

            await page.render(renderContext).promise;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            const totalPages = currentPdfDoc.numPages;
            document.getElementById('pageInfo').textContent = `–°—Ç—Ä. ${pageNum} –∏–∑ ${totalPages}`;
        }

        function nextPage() {
            if (!currentPdfDoc) return;
            if (currentPageNum < currentPdfDoc.numPages) {
                currentPageNum++;
                renderPdfPage(currentPageNum);
            }
        }

        function previousPage() {
            if (!currentPdfDoc) return;
            if (currentPageNum > 1) {
                currentPageNum--;
                renderPdfPage(currentPageNum);
            }
        }

        function closePdfPreview() {
            document.getElementById('pdfModal').style.display = 'none';
            currentPdfDoc = null;
            currentPageNum = 1;
        }

        // ===== BATCH –†–ï–ù–î–ï–†–ò–ù–ì =====
        async function loadBatchCollections() {
            try {
                const resp = await fetch('/api/collections');
                const collections = await resp.json();

                const select = document.getElementById('batchRenderCollection');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>';
                collections.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                });

                document.getElementById('batchTemplatesCheckboxes').innerHTML = '';
                document.getElementById('batchVariablesSection').innerHTML = '';
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–π', 'error');
            }
        }

        async function loadBatchTemplates() {
            const collectionId = document.getElementById('batchRenderCollection').value;
            if (!collectionId) {
                document.getElementById('batchTemplatesCheckboxes').innerHTML = '';
                document.getElementById('batchVariablesSection').innerHTML = '';
                return;
            }

            try {
                const resp = await fetch(`/api/collections/${collectionId}/templates`);
                const templates = await resp.json();

                const checkboxesDiv = document.getElementById('batchTemplatesCheckboxes');

                if (templates.length === 0) {
                    checkboxesDiv.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><p>–ù–µ—Ç —à–∞–±–ª–æ–Ω–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</p></div>';
                    return;
                }

                checkboxesDiv.innerHTML = templates.map(t => `
                    <div class="card">
                        <div class="checkbox-group" style="align-items: flex-start; margin: 0;">
                            <input type="checkbox" id="template_${safeId(t.id)}" data-template-id="${t.id}" data-template-name="${t.name}">
                            <div style="flex: 1;">
                                <label for="template_${safeId(t.id)}" style="margin: 0; cursor: pointer; user-select: none;">
                                    <strong>${t.name}</strong>
                                </label>
                                <p style="color: #666; font-size: 0.9em; margin-top: 5px;">${t.original_filename}</p>
                                <p style="color: #999; font-size: 0.85em;">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: ${Object.keys(t.variables || {}).length}</p>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Add event listeners to checkboxes
                document.querySelectorAll('#batchTemplatesCheckboxes input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', loadBatchVariables);
                });

                document.getElementById('batchVariablesSection').innerHTML = '';
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤', 'error');
            }
        }

        async function loadBatchVariables() {
            const collectionId = document.getElementById('batchRenderCollection').value;
            if (!collectionId) return;

            const selectedCheckboxes = document.querySelectorAll('#batchTemplatesCheckboxes input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) {
                document.getElementById('batchVariablesSection').innerHTML = '';
                return;
            }

            try {
                // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
                const allVariables = {};
                const templateIds = [];

                for (const checkbox of selectedCheckboxes) {
                    templateIds.push(checkbox.dataset.templateId);
                }

                // –ü–æ–ª—É—á–∞–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                const templateIdsStr = templateIds.join(',');
                const resp = await fetch(`/api/collections/${collectionId}/aggregate-variables?template_ids=${templateIdsStr}`);
                const aggregated = await resp.json();

                const vars = aggregated.variables || {};

                if (Object.keys(vars).length === 0) {
                    document.getElementById('batchVariablesSection').innerHTML = '<div class="section"><div class="empty-state"><p>–ù–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–∞—Ö</p></div></div>';
                    return;
                }

                let html = '<div class="section"><h2>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤</h2><div class="variable-section">';

                Object.entries(vars).forEach(([name, v]) => {
                    const displayName = v.metadata?.display_name || name;
                    const description = v.metadata?.description || '';
                    const value = v.value || '';
                    const authors = v.authors && v.authors.length > 0 ? v.authors : [];

                    let authorsHtml = '';
                    if (authors.length > 0) {
                        authorsHtml = `<p style="font-size: 0.75em; color: #999;">üë§ ${authors.map(a => a.author || 'Unknown').join(', ')}</p>`;
                    }

                    if (v.type === 'checkbox') {
                        html += `
                            <div class="form-group">
                                <label>${displayName}</label>
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 8px;">${description}</p>
                                ${authorsHtml}
                                <div class="checkbox-group">
                                    <input type="checkbox" id="batchvar_${safeId(name)}" data-var-name="${name}" ${value ? 'checked' : ''}>
                                    <label for="batchvar_${safeId(name)}" style="margin: 0;">–û—Ç–º–µ—á–µ–Ω–æ</label>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="form-group">
                                <label>${displayName}</label>
                                <p style="color: #666; font-size: 0.9em; margin-bottom: 8px;">${description}</p>
                                ${authorsHtml}
                                <input type="text" id="batchvar_${safeId(name)}" data-var-name="${name}" value="${value}" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
                            </div>
                        `;
                    }
                });

                html += '</div></div>';
                document.getElementById('batchVariablesSection').innerHTML = html;
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö', 'error');
            }
        }

        async function performBatchRender() {
            const collectionId = document.getElementById('batchRenderCollection').value;
            const selectedCheckboxes = document.querySelectorAll('#batchTemplatesCheckboxes input[type="checkbox"]:checked');

            if (!collectionId) {
                showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é', 'error');
                return;
            }

            if (selectedCheckboxes.length === 0) {
                showStatus('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–±–ª–æ–Ω', 'error');
                return;
            }

            const templateIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.templateId);

            // –°–æ–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            const variables = {};
            document.querySelectorAll('#batchVariablesSection [data-var-name]').forEach(input => {
                const name = input.dataset.varName;
                if (input.type === 'checkbox') {
                    variables[name] = input.checked;
                } else {
                    variables[name] = input.value;
                }
            });

            try {
                showStatus('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞—Ä—Ö–∏–≤... —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è', 'success');

                const resp = await fetch('/api/render/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        collection_id: collectionId,
                        template_ids: templateIds,
                        variables
                    })
                });

                if (!resp.ok) {
                    const error = await resp.text();
                    throw new Error(error);
                }

                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `batch_render_${Date.now()}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('–ê—Ä—Ö–∏–≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–∫–∞—á–∞–Ω ‚úì');
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            loadCollections();
            loadCollectionsForRender();
        });
    </script>
</body>

</html>